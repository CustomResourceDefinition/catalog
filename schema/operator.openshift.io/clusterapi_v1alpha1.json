{
  "description": "ClusterAPI provides configuration for the capi-operator.\n\nCompatibility level 4: No compatibility is provided, the API can change at any point for any reason. These capabilities should not be used by applications needing long term support.",
  "type": "object",
  "required": [
    "metadata",
    "spec"
  ],
  "properties": {
    "apiVersion": {
      "description": "APIVersion defines the versioned schema of this representation of an object.\nServers should convert recognized schemas to the latest internal value, and\nmay reject unrecognized values.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources",
      "type": "string"
    },
    "kind": {
      "description": "Kind is a string value representing the REST resource this object represents.\nServers may infer this from the endpoint the client submits requests to.\nCannot be updated.\nIn CamelCase.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds",
      "type": "string"
    },
    "metadata": {
      "type": "object"
    },
    "spec": {
      "description": "spec is the specification of the desired behavior of the capi-operator.",
      "type": "object",
      "minProperties": 0,
      "properties": {
        "unmanagedCustomResourceDefinitions": {
          "description": "unmanagedCustomResourceDefinitions is a list of ClusterResourceDefinition (CRD)\nnames that should not be managed by the capi-operator installer\ncontroller. This allows external actors to own specific CRDs while\ncapi-operator manages others.\n\nEach CRD name must be a valid DNS-1123 subdomain consisting of lowercase\nalphanumeric characters, '-' or '.', and must start and end with an\nalphanumeric character, with a maximum length of 253 characters.\nCRD names must contain at least two '.' characters.\nExample: \"clusters.cluster.x-k8s.io\"\n\nItems cannot be removed from this list once added.\n\nThe maximum number of unmanagedCustomResourceDefinitions is 128.",
          "type": "array",
          "maxItems": 128,
          "minItems": 1,
          "items": {
            "type": "string",
            "maxLength": 253,
            "minLength": 1,
            "x-kubernetes-validations": [
              {
                "rule": "!format.dns1123Subdomain().validate(self).hasValue()",
                "message": "a lowercase RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."
              },
              {
                "rule": "self.split('.').size() \u003e 2",
                "message": "CRD names must contain at least two '.' characters."
              }
            ]
          },
          "x-kubernetes-list-type": "set",
          "x-kubernetes-validations": [
            {
              "rule": "oldSelf.all(item, item in self)",
              "message": "items cannot be removed from unmanagedCustomResourceDefinitions list"
            }
          ]
        }
      },
      "additionalProperties": false,
      "x-kubernetes-validations": [
        {
          "rule": "!has(oldSelf.unmanagedCustomResourceDefinitions) || has(self.unmanagedCustomResourceDefinitions)",
          "message": "unmanagedCustomResourceDefinitions cannot be unset once set"
        }
      ]
    },
    "status": {
      "description": "status defines the observed status of the capi-operator.",
      "type": "object",
      "required": [
        "desiredRevision",
        "revisions"
      ],
      "properties": {
        "currentRevision": {
          "description": "currentRevision is the name of the most recently fully applied revision.\nIt is written by the installer controller. If it is absent, it indicates\nthat no revision has been fully applied yet.\nIf set, currentRevision must correspond to an entry in the revisions list.",
          "type": "string",
          "maxLength": 255,
          "minLength": 1
        },
        "desiredRevision": {
          "description": "desiredRevision is the name of the desired revision. It is written by the\nrevision controller. It must be set to the name of the entry in the\nrevisions list with the highest revision number.",
          "type": "string",
          "maxLength": 255,
          "minLength": 1
        },
        "revisions": {
          "description": "revisions is a list of all currently active revisions. A revision is\nactive until the installer controller updates currentRevision to a later\nrevision. It is written by the revision controller.\n\nThe maximum number of revisions is 16.\nAll revisions must have a unique name.\nAll revisions must have a unique revision number.\nWhen adding a revision, the revision number must be greater than the highest revision number in the list.\nRevisions are immutable, although they can be deleted.",
          "type": "array",
          "maxItems": 16,
          "minItems": 1,
          "items": {
            "type": "object",
            "required": [
              "components",
              "contentID",
              "name",
              "revision"
            ],
            "properties": {
              "components": {
                "description": "components is list of components which will be installed by this\nrevision. Components will be installed in the order they are listed.\n\nThe maximum number of components is 32.",
                "type": "array",
                "maxItems": 32,
                "minItems": 1,
                "items": {
                  "description": "ClusterAPIInstallerComponent defines a component which will be installed by this revision.",
                  "type": "object",
                  "required": [
                    "type"
                  ],
                  "properties": {
                    "image": {
                      "description": "image defines an image source for a component. The image must contain a\n/capi-operator-installer directory containing the component manifests.",
                      "type": "object",
                      "required": [
                        "profile",
                        "ref"
                      ],
                      "properties": {
                        "profile": {
                          "description": "profile is the name of a profile to use from the image.\n\nA profile name may be up to 255 characters long. It must consist of alphanumeric characters, '-', or '_'.",
                          "type": "string",
                          "maxLength": 255,
                          "minLength": 1,
                          "x-kubernetes-validations": [
                            {
                              "rule": "self.matches('^[a-zA-Z0-9-_]+$')",
                              "message": "profile must consist of alphanumeric characters, '-', or '_'"
                            }
                          ]
                        },
                        "ref": {
                          "description": "ref is an image reference to the image containing the component manifests. The reference\nmust be a valid image digest reference in the format host[:port][/namespace]/name@sha256:\u003cdigest\u003e.\nThe digest must be 64 characters long, and consist only of lowercase hexadecimal characters, a-f and 0-9.\nThe length of the field must be between 1 to 447 characters.",
                          "type": "string",
                          "maxLength": 447,
                          "minLength": 1,
                          "x-kubernetes-validations": [
                            {
                              "rule": "(self.split('@').size() == 2 \u0026\u0026 self.split('@')[1].matches('^sha256:[a-f0-9]{64}$'))",
                              "message": "the OCI Image reference must end with a valid '@sha256:\u003cdigest\u003e' suffix, where '\u003cdigest\u003e' is 64 characters long"
                            },
                            {
                              "rule": "(self.split('@')[0].matches('^([a-zA-Z0-9-]+\\\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$'))",
                              "message": "the OCI Image name should follow the host[:port][/namespace]/name format, resembling a valid URL without the scheme"
                            }
                          ]
                        }
                      },
                      "additionalProperties": false
                    },
                    "type": {
                      "description": "type is the source type of the component.\nThe only valid value is Image.\nWhen set to Image, the image field must be set and will define an image source for the component.",
                      "type": "string",
                      "enum": [
                        "Image"
                      ]
                    }
                  },
                  "additionalProperties": false,
                  "x-kubernetes-validations": [
                    {
                      "rule": "self.type == 'Image' ? has(self.image) : !has(self.image)",
                      "message": "image is required when type is Image, and forbidden otherwise"
                    }
                  ]
                },
                "x-kubernetes-list-type": "atomic"
              },
              "contentID": {
                "description": "contentID uniquely identifies the content of this revision.\nThe contentID must be between 1 and 255 characters long.",
                "type": "string",
                "maxLength": 255,
                "minLength": 1
              },
              "name": {
                "description": "name is the name of a revision.",
                "type": "string",
                "maxLength": 255,
                "minLength": 1
              },
              "revision": {
                "description": "revision is a monotonically increasing number that is assigned to a revision.",
                "type": "integer",
                "format": "int64",
                "minimum": 1
              },
              "unmanagedCustomResourceDefinitions": {
                "description": "unmanagedCustomResourceDefinitions is a list of the names of\nClusterResourceDefinition (CRD) objects which are included in this\nrevision, but which should not be installed or updated. If not set, all\nCRDs in the revision will be managed by the CAPI operator.",
                "type": "array",
                "maxItems": 128,
                "minItems": 1,
                "items": {
                  "type": "string",
                  "maxLength": 253,
                  "minLength": 1,
                  "x-kubernetes-validations": [
                    {
                      "rule": "!format.dns1123Subdomain().validate(self).hasValue()",
                      "message": "a lowercase RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."
                    }
                  ]
                },
                "x-kubernetes-list-type": "atomic"
              }
            },
            "additionalProperties": false,
            "x-kubernetes-map-type": "atomic"
          },
          "x-kubernetes-list-type": "atomic",
          "x-kubernetes-validations": [
            {
              "rule": "self.all(x, self.exists_one(y, x.name == y.name))",
              "message": "each revision must have a unique name"
            },
            {
              "rule": "self.all(x, self.exists_one(y, x.revision == y.revision))",
              "message": "each revision must have a unique revision number"
            },
            {
              "rule": "self.all(new, oldSelf.exists(old, old.name == new.name) || oldSelf.all(old, new.revision \u003e old.revision))",
              "message": "new revisions must have a revision number greater than all existing revisions"
            },
            {
              "rule": "oldSelf.all(old, !self.exists(new, new.name == old.name) || self.exists(new, new == old))",
              "message": "existing revisions are immutable, but may be removed"
            }
          ]
        }
      },
      "additionalProperties": false,
      "x-kubernetes-validations": [
        {
          "rule": "self.revisions.exists(r, r.name == self.desiredRevision \u0026\u0026 self.revisions.all(s, s.revision \u003c= r.revision))",
          "message": "desiredRevision must be the name of the revision with the highest revision number"
        },
        {
          "rule": "!has(self.currentRevision) || self.revisions.exists(r, r.name == self.currentRevision)",
          "message": "currentRevision must correspond to an entry in the revisions list"
        }
      ]
    }
  },
  "x-kubernetes-validations": [
    {
      "rule": "self.metadata.name == 'cluster'",
      "message": "clusterapi is a singleton, .metadata.name must be 'cluster'"
    }
  ]
}
