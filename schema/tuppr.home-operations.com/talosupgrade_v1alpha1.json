{
  "description": "TalosUpgrade is the Schema for the talosupgrades API",
  "type": "object",
  "properties": {
    "apiVersion": {
      "description": "APIVersion defines the versioned schema of this representation of an object.\nServers should convert recognized schemas to the latest internal value, and\nmay reject unrecognized values.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources",
      "type": "string"
    },
    "kind": {
      "description": "Kind is a string value representing the REST resource this object represents.\nServers may infer this from the endpoint the client submits requests to.\nCannot be updated.\nIn CamelCase.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds",
      "type": "string"
    },
    "metadata": {
      "type": "object"
    },
    "spec": {
      "description": "TalosUpgradeSpec defines the desired state of TalosUpgrade",
      "type": "object",
      "properties": {
        "drain": {
          "description": "Drain configuration for the node prior to upgrade",
          "type": "object",
          "properties": {
            "deleteLocalData": {
              "description": "DeleteLocalData causes the drain to continue even if there are pods using emptyDir\n(local data that will be deleted when the node is drained).",
              "type": "boolean"
            },
            "disableEviction": {
              "description": "DisableEviction forces drain to use delete, even if eviction is supported.",
              "type": "boolean"
            },
            "force": {
              "description": "Force continues even if there are pods that do not declare a controller.",
              "type": "boolean"
            },
            "ignoreDaemonSets": {
              "description": "IgnoreDaemonSets ignores DaemonSet-managed pods.",
              "type": "boolean"
            },
            "skipWaitForDeleteTimeout": {
              "description": "SkipWaitForDeleteTimeout specifies that if a pod DeletionTimestamp is older than N seconds,\nskip waiting for the pod. Seconds must be greater than 0 to skip.",
              "type": "integer"
            }
          },
          "additionalProperties": false
        },
        "healthChecks": {
          "description": "HealthChecks defines a list of CEL-based health checks to perform before each node upgrade",
          "type": "array",
          "items": {
            "description": "HealthCheck defines a CEL-based health check",
            "type": "object",
            "required": [
              "apiVersion",
              "expr",
              "kind"
            ],
            "properties": {
              "apiVersion": {
                "description": "APIVersion of the resource to check",
                "type": "string"
              },
              "description": {
                "description": "Description of what this check validates (for status/logging)",
                "type": "string"
              },
              "expr": {
                "description": "CEL expression that must evaluate to true for the check to pass\nThe resource object is available as 'object' and status as 'status'",
                "type": "string"
              },
              "kind": {
                "description": "Kind of the resource to check",
                "type": "string"
              },
              "name": {
                "description": "Name of the specific resource (optional, if empty checks all resources of this kind)",
                "type": "string"
              },
              "namespace": {
                "description": "Namespace of the resource (optional, for namespaced resources)",
                "type": "string"
              },
              "timeout": {
                "description": "Timeout for this health check",
                "type": "string",
                "minLength": 2,
                "pattern": "^([0-9]+[smh])+$"
              }
            },
            "additionalProperties": false
          }
        },
        "maintenance": {
          "description": "Maintenance configuration behavior for upgrade operations",
          "type": "object",
          "properties": {
            "windows": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "required": [
                  "duration",
                  "start"
                ],
                "properties": {
                  "duration": {
                    "description": "How long the window stays open (e.g., \"4h\", \"2h30m\")",
                    "type": "string",
                    "pattern": "^([0-9]+[smh])+$"
                  },
                  "start": {
                    "description": "Cron expression (5-field): minute hour day-of-month month day-of-week",
                    "type": "string",
                    "minLength": 9
                  },
                  "timezone": {
                    "description": "IANA timezone (e.g., \"UTC\", \"Europe/Paris\")",
                    "type": "string",
                    "default": "UTC"
                  }
                },
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        },
        "nodeSelector": {
          "description": "NodeSelector defines which nodes should be included in this upgrade.",
          "type": "object",
          "properties": {
            "matchExpressions": {
              "description": "matchExpressions is a list of label selector requirements. The requirements are ANDed.",
              "type": "array",
              "items": {
                "description": "A label selector requirement is a selector that contains values, a key, and an operator that\nrelates the key and values.",
                "type": "object",
                "required": [
                  "key",
                  "operator"
                ],
                "properties": {
                  "key": {
                    "description": "key is the label key that the selector applies to.",
                    "type": "string"
                  },
                  "operator": {
                    "description": "operator represents a key's relationship to a set of values.\nValid operators are In, NotIn, Exists and DoesNotExist.",
                    "type": "string"
                  },
                  "values": {
                    "description": "values is an array of string values. If the operator is In or NotIn,\nthe values array must be non-empty. If the operator is Exists or DoesNotExist,\nthe values array must be empty. This array is replaced during a strategic\nmerge patch.",
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "x-kubernetes-list-type": "atomic"
                  }
                },
                "additionalProperties": false
              },
              "x-kubernetes-list-type": "atomic"
            },
            "matchLabels": {
              "description": "matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels\nmap is equivalent to an element of matchExpressions, whose key field is \"key\", the\noperator is \"In\", and the values array contains only \"value\". The requirements are ANDed.",
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            }
          },
          "additionalProperties": false,
          "x-kubernetes-map-type": "atomic"
        },
        "policy": {
          "description": "Policy configures upgrade behavior",
          "type": "object",
          "properties": {
            "debug": {
              "description": "Debug enables debug mode for the upgrade",
              "type": "boolean",
              "default": true
            },
            "force": {
              "description": "Force the upgrade (skip checks on etcd health and members)",
              "type": "boolean",
              "default": false
            },
            "placement": {
              "description": "Placement controls how strictly upgrade jobs avoid the target node\nhard: required avoidance (job will fail if can't avoid target node)\nsoft: preferred avoidance (job prefers to avoid but can run on target node)",
              "type": "string",
              "default": "soft",
              "enum": [
                "hard",
                "soft"
              ]
            },
            "rebootMode": {
              "description": "RebootMode select the reboot mode during upgrade",
              "type": "string",
              "default": "default",
              "enum": [
                "default",
                "powercycle"
              ]
            },
            "stage": {
              "description": "Stage the upgrade to perform it after a reboot",
              "type": "boolean",
              "default": false
            },
            "timeout": {
              "description": "Timeout for the per-node talosctl upgrade command",
              "type": "string",
              "default": "30m",
              "pattern": "^([0-9]+[smh])+$"
            }
          },
          "additionalProperties": false
        },
        "talos": {
          "description": "Talos specifies the talos configuration for upgrade operations",
          "type": "object",
          "required": [
            "version"
          ],
          "properties": {
            "version": {
              "description": "Version is the target Talos version to upgrade to (e.g., \"v1.11.0\")",
              "type": "string",
              "pattern": "^v[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9\\-\\.]+)?$"
            }
          },
          "additionalProperties": false
        },
        "talosctl": {
          "description": "Talosctl specifies the talosctl configuration for upgrade operations",
          "type": "object",
          "properties": {
            "image": {
              "description": "Image specifies the talosctl container image",
              "type": "object",
              "properties": {
                "pullPolicy": {
                  "description": "PullPolicy describes a policy for if/when to pull a container image",
                  "type": "string",
                  "default": "IfNotPresent",
                  "enum": [
                    "Always",
                    "Never",
                    "IfNotPresent"
                  ]
                },
                "repository": {
                  "description": "Repository is the talosctl container image repository",
                  "type": "string",
                  "default": "ghcr.io/siderolabs/talosctl"
                },
                "tag": {
                  "description": "Tag is the talosctl container image tag\nIf not specified, defaults to the target version",
                  "type": "string"
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "status": {
      "description": "TalosUpgradeStatus defines the observed state of TalosUpgrade",
      "type": "object",
      "properties": {
        "completedNodes": {
          "description": "CompletedNodes are nodes that have been successfully upgraded",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "currentNode": {
          "description": "CurrentNode is the node currently being upgraded",
          "type": "string"
        },
        "failedNodes": {
          "description": "FailedNodes are nodes that failed to upgrade",
          "type": "array",
          "items": {
            "description": "NodeUpgradeStatus tracks the upgrade status of individual nodes",
            "type": "object",
            "required": [
              "nodeName"
            ],
            "properties": {
              "jobName": {
                "description": "JobName is the name of the job handling this node's upgrade",
                "type": "string"
              },
              "lastError": {
                "description": "LastError contains the last error message",
                "type": "string"
              },
              "nodeName": {
                "description": "NodeName is the name of the node",
                "type": "string"
              },
              "retries": {
                "description": "Retries is the number of times upgrade was attempted",
                "type": "integer",
                "minimum": 0
              }
            },
            "additionalProperties": false
          }
        },
        "lastUpdated": {
          "description": "LastUpdated timestamp of last status update",
          "type": "string",
          "format": "date-time"
        },
        "message": {
          "description": "Message provides details about the current state",
          "type": "string"
        },
        "nextMaintenanceWindow": {
          "description": "NextMaintenanceWindow reflect the next time a maintenance can happen",
          "type": "string",
          "format": "date-time"
        },
        "observedGeneration": {
          "description": "ObservedGeneration reflects the generation of the most recently observed spec",
          "type": "integer",
          "format": "int64"
        },
        "phase": {
          "description": "Phase represents the current phase of the upgrade",
          "type": "string",
          "allOf": [
            {
              "enum": [
                "Pending",
                "HealthChecking",
                "Draining",
                "Upgrading",
                "Rebooting",
                "Completed",
                "Failed",
                "MaintenanceWindow"
              ]
            },
            {
              "enum": [
                "Pending",
                "HealthChecking",
                "Draining",
                "Upgrading",
                "Rebooting",
                "Completed",
                "Failed"
              ]
            }
          ]
        }
      },
      "additionalProperties": false
    }
  }
}
